import os
import logging
from telegram import Update, BotCommand
from telegram.ext import Application, CommandHandler, MessageHandler, CallbackQueryHandler, ConversationHandler, filters

# Importar configura√ß√µes e m√≥dulos
from config import *
from database import db
from keep_alive import keep_alive

# Importar handlers
from handlers import (
    start, ajuda, cancelar, meu_id,
    receber_nome, receber_sobrenome, receber_regiao,
    receber_sa, receber_gpon, receber_tipo, receber_serial, receber_serial_mesh, receber_foto, finalizar, receber_print_autofill, receber_serial_por_foto, receber_serial_mesh_por_foto,
    button_callback, consultar, comando_consultar, comando_reparo, comando_producao,
    comando_mensal, comando_semanal, comando_hoje, receber_data_inicio, receber_data_fim
)
from admin_handlers import (
    admin_panel, admin_callback_handler, admin_broadcast_handler, confirmar_broadcast
)

# Configura√ß√£o de Logging
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

def main():
    # Obter token
    TOKEN = os.getenv("TELEGRAM_TOKEN")
    if not TOKEN:
        # Tentar ler de arquivo (para compatibilidade com c√≥digo antigo)
        try:
            with open("TELEGRAM_TOKEN", "r") as f:
                TOKEN = f.read().strip()
        except:
            pass
            
    if not TOKEN:
        logger.error("TELEGRAM_TOKEN n√£o encontrado!")
        return

    # Inicializar App
    app = Application.builder().token(TOKEN).build()

    # Definir comandos do bot
    async def post_init(application: Application) -> None:
        await application.bot.set_my_commands([
            BotCommand("start", "Menu principal"),
            BotCommand("ajuda", "Ajuda"),
            BotCommand("cancelar", "Cancelar opera√ß√£o"),
            BotCommand("producao", "Ver produ√ß√£o"),
            BotCommand("mensal", "Relat√≥rio mensal"),
            BotCommand("semanal", "Relat√≥rio semanal"),
            BotCommand("hoje", "Relat√≥rio de hoje"),
            BotCommand("consultar", "Consultar instala√ß√£o"),
            BotCommand("reparo", "Registrar reparo"),
            BotCommand("admin", "Painel Admin")
        ])
        # Verificar banco de dados
        health = await db.check_health()
        if health:
            logger.info("‚úÖ Conex√£o com Supabase OK!")
        else:
            logger.warning("‚ùå Falha na conex√£o com Supabase!")

    app.post_init = post_init

    # Configurar ConversationHandler
    conv_handler = ConversationHandler(
        entry_points=[
            CommandHandler('start', start),
            CommandHandler('producao', comando_producao),
            CommandHandler('consultar', comando_consultar),
            CommandHandler('reparo', comando_reparo),
            CallbackQueryHandler(button_callback)
        ],
        states={
            # Cadastro Inicial
            AGUARDANDO_NOME: [MessageHandler(filters.TEXT & ~filters.COMMAND, receber_nome)],
            AGUARDANDO_SOBRENOME: [MessageHandler(filters.TEXT & ~filters.COMMAND, receber_sobrenome)],
            AGUARDANDO_REGIAO: [MessageHandler(filters.TEXT & ~filters.COMMAND, receber_regiao)],
            
            # Fluxo de Registro
            AGUARDANDO_SA: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, receber_sa),
                MessageHandler(filters.PHOTO, receber_print_autofill)
            ],
            AGUARDANDO_GPON: [MessageHandler(filters.TEXT & ~filters.COMMAND, receber_gpon)],
            AGUARDANDO_TIPO: [CallbackQueryHandler(receber_tipo)],
            AGUARDANDO_SERIAL: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, receber_serial),
                MessageHandler(filters.PHOTO, receber_serial_por_foto)
            ],
            AGUARDANDO_SERIAL_MESH: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, receber_serial_mesh),
                MessageHandler(filters.PHOTO, receber_serial_mesh_por_foto)
            ],
            AGUARDANDO_FOTOS: [
                MessageHandler(filters.PHOTO, receber_foto),
                CommandHandler('finalizar', finalizar),
                CallbackQueryHandler(button_callback) # Para retry
            ],
            
            # Consultas
            AGUARDANDO_CONSULTA: [MessageHandler(filters.TEXT & ~filters.COMMAND, consultar)],
            
            # Relat√≥rio por Per√≠odo
            AGUARDANDO_DATA_INICIO: [MessageHandler(filters.TEXT & ~filters.COMMAND, receber_data_inicio)],
            AGUARDANDO_DATA_FIM: [MessageHandler(filters.TEXT & ~filters.COMMAND, receber_data_fim)],
            
            # Admin Broadcast
            AGUARDANDO_BROADCAST: [
                MessageHandler(filters.TEXT | filters.PHOTO | filters.VIDEO | filters.Document.ALL, admin_broadcast_handler)
            ],
            AGUARDANDO_CONFIRMACAO_BROADCAST: [CallbackQueryHandler(confirmar_broadcast)]
        },
        fallbacks=[CommandHandler('cancelar', cancelar)],
        per_message=False
    )

    # Adicionar handlers
    app.add_handler(CommandHandler('admin', admin_panel))
    app.add_handler(CommandHandler('meuid', meu_id))
    app.add_handler(CommandHandler('ajuda', ajuda))
    app.add_handler(CommandHandler('mensal', comando_mensal))
    app.add_handler(CommandHandler('semanal', comando_semanal))
    app.add_handler(CommandHandler('hoje', comando_hoje))
    app.add_handler(CommandHandler('reparo', comando_reparo))
    
    # Handlers de Admin (Callbacks)
    app.add_handler(CallbackQueryHandler(admin_callback_handler, pattern='^admin_'))
    
    # Conversation Handler (deve vir por √∫ltimo para pegar os callbacks gen√©ricos se n√£o for admin)
    app.add_handler(conv_handler)

    # Iniciar servidor web falso (Render)
    keep_alive()

    logger.info("ü§ñ Bot iniciado!")
    app.run_polling()

if __name__ == '__main__':
    main()
